---
title: 关于服务器卡顿原因
published: 2025-12-08
description:  '记一次服务器卡顿解决方案'
image: ''
tags: [服务器]
category: '我的世界'
draft: false
---

## 前言

这个问题已经得到解决，希望能为迟迟找不到服务器卡顿的朋友提供一些思路。

Chspif月初配置由14900k迁移到了9950x，对于单核性能来说，后者纸面数据不如前者。

但实际跑分测试发现14900k存在缩缸问题，且服务器也搭配使用了Async这类伪多核优化mod尽可能分担运算压力，服务器表现理论来说应该会更好。

但实际跑下来MSTP表现极差，在只有16名玩家的情况下表现远远不如14900k。

<center>

![](https://img.cdn1.vip/i/6936f52444169_1765209380.webp)

</center>

这个问题困扰了我一周之久，从游戏内到服务器端环境再到Java参数等等，测试了很多次都不尽人意。

直到后面我注意到GC释放耗时很长和堆红的内存，我意识到这个问题可能是出在服务器的数据包上。

<center>

![](https://img.cdn1.vip/i/6936f63b999b1_1765209659.webp)

</center>

## 数据包运作过程
我平时会给服务器写一些计分板和成就来展示服务器内玩家的数据。

<center>

![](https://img.cdn1.vip/i/6936f6b6c3177_1765209782.webp)

</center>

<center>

![](https://img.cdn1.vip/i/6936f6bf097bd_1765209791.webp)

</center>

在优化之前，它是这样运作的。

<center>

![](https://img.cdn1.vip/i/6936f89b0d8d5_1765210267.png)

</center>


服务器分为计分板和成就部分。

其中我通过函数实现了一个自循环的时钟功能。

黄色链路是通过接入游戏原生的统计数据，通过计算整理经手tick函数转化为易读的数据，同步至记分板，这个频率是tick级别的。

蓝色链路是通过tick函数检查计分板分数来触发成就，这个频率是tick级别的。

红色链路是每次时钟循环一次，通过tick循环检验信号来实现切换展示计分板的功能，时钟频率是分秒级别的，tick检验频率是tick级别的。

通过计算，在优化前，tick函数经手的函数量为11条。其中成就检验子函数的函数量为15条，计分板子函数函数量为91条。

仅仅是这三个主要部分每tick的函数量接近120条。即每个玩家每秒需要计算的函数操作约为2400条。

一旦玩家数量多起来，这个计算量还是规模不小的。这就是服务器GC迟迟得不到释放，导致内存爆掉，MSTP飞天的原因。

## 优化
首先我修改了基本逻辑，让所有的数据同步和成就质询不再为tick级别的。

<center>

![](https://img.cdn1.vip/i/6936fc273335e_1765211175.png)

</center>

我将质询和同步行为都接在时钟给出的信号上，让他们的行为频率达到和计分板切换一样的分秒级别的频率；并且我删除了一些成就和计分板，避免带来不需要的计算。

在优化后，tick函数经手的函数为9条。其中成就检验子函数处理时间为9s，函数量为11条；计分板同步子函数处理时间为9s，函数量为21条。

计算可得每个玩家每秒需要计算的函数操作约为252条，相较于2400条，计算得到了极致的优化。

当然，实际测试数据也没有辜负期望，在平均15名玩家的60分钟测试中，MSPT平均值为32.6。

<center>

![](https://img.cdn1.vip/i/6936fe221c076_1765211682.webp)

</center>

我们服务器的数据包为开源项目，如果你希望看到更多细节，可以前往我们的仓库。

::github{repo="Chspif/Chspif_minecraft_datapack"}